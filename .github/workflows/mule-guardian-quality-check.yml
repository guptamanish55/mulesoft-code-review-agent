name: Mule Guardian Code Quality Check (Reusable)

# THIS IS A REUSABLE WORKFLOW - Called from other repositories
on:
  workflow_call:
    inputs:
      # Input parameters that calling repositories can customize
      compliance_threshold:
        description: 'Minimum compliance percentage required'
        required: false
        type: number
        default: 75
      pmd_version:
        description: 'PMD version to use'
        required: false
        type: string
        default: '7.0.0'
      analysis_target:
        description: 'Directory to analyze (relative to repo root)'
        required: false
        type: string
        default: '.'
      project_name:
        description: 'Name of the project being analyzed'
        required: false
        type: string
        default: 'MuleSoft Project'
      skip_quality_gate:
        description: 'Skip quality gate check (for debugging)'
        required: false
        type: boolean
        default: false
    outputs:
      # Outputs that calling workflows can use
      compliance_score:
        description: 'Calculated compliance percentage'
        value: ${{ jobs.code-quality-check.outputs.compliance_score }}
      total_violations:
        description: 'Total number of violations found'
        value: ${{ jobs.code-quality-check.outputs.total_violations }}
      quality_gate_passed:
        description: 'Whether quality gate passed'
        value: ${{ jobs.code-quality-check.outputs.quality_gate_passed }}

jobs:
  code-quality-check:
    runs-on: ubuntu-latest
    
    # Set outputs for the job
    outputs:
      compliance_score: ${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}
      total_violations: ${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}
      quality_gate_passed: ${{ steps.quality-gate.outputs.GATE_PASSED }}
    
    steps:
    # Step 1: Get the calling repository's code
    - name: Checkout Application Code
      uses: actions/checkout@v4
      
    # Step 2: Get Mule Guardian files from this common repository
    - name: Get Mule Guardian Core Files
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/mulesoft-code-review-agent  # ‚Üê Change this to your common repo name
        path: mule-guardian
        ref: main
        
    # Step 3: Copy core files to working directory
    - name: Setup Mule Guardian Files
      run: |
        echo "üìã Setting up Mule Guardian files..."
        
        # Copy core files from the common repo checkout
        cp mule-guardian/mulesoft_ai_code_review_agent.py .
        cp mule-guardian/comprehensive-mulesoft-ruleset-no-debug.xml .
        cp mule-guardian/requirements.txt .
        
        echo "‚úÖ Core files copied from common repository"
        
        # Verify files exist
        for file in mulesoft_ai_code_review_agent.py comprehensive-mulesoft-ruleset-no-debug.xml requirements.txt; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Error: $file not found"
            exit 1
          fi
          echo "‚úÖ Found: $file"
        done
      
    # Step 4: Setup Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    # Step 5: Setup Java (required for PMD)
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    # Step 6: Install PMD
    - name: Install PMD
      run: |
        echo "üì¶ Installing PMD version ${{ inputs.pmd_version }}..."
        
        # Try multiple download methods for PMD
        if wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F${{ inputs.pmd_version }}/pmd-bin-${{ inputs.pmd_version }}.zip; then
          echo "‚úÖ Downloaded PMD ${{ inputs.pmd_version }}"
          unzip pmd-bin-${{ inputs.pmd_version }}.zip
          sudo mv pmd-bin-${{ inputs.pmd_version }} /opt/pmd
        elif wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-bin-7.0.0.zip; then
          echo "‚úÖ Downloaded PMD 7.0.0 as fallback"
          unzip pmd-bin-7.0.0.zip
          sudo mv pmd-bin-7.0.0 /opt/pmd
        else
          echo "‚ö†Ô∏è Using package manager installation..."
          sudo apt-get update && sudo apt-get install -y pmd
          sudo mkdir -p /opt/pmd/bin
          sudo ln -sf $(which pmd) /opt/pmd/bin/pmd
        fi
        
        # Create expected paths
        sudo mkdir -p /opt/homebrew/bin
        sudo ln -sf /opt/pmd/bin/pmd /opt/homebrew/bin/pmd
        echo "/opt/pmd/bin" >> $GITHUB_PATH
        echo "/opt/homebrew/bin" >> $GITHUB_PATH
        
        # Verify installation
        /opt/pmd/bin/pmd --version
        echo "‚úÖ PMD installed successfully"
        
    # Step 7: Install Python Dependencies
    - name: Install Python Dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed successfully"
        
    # Step 8: Run Mule Guardian Analysis
    - name: Run Mule Guardian Analysis
      id: mule-analysis
      run: |
        echo "üîç Starting Mule Guardian analysis..."
        echo "üìç Project: ${{ inputs.project_name }}"
        echo "üìÇ Analyzing: ${{ inputs.analysis_target }}"
        
        # Validate analysis target
        if [ ! -d "${{ inputs.analysis_target }}" ]; then
          echo "‚ùå Analysis target directory not found: ${{ inputs.analysis_target }}"
          exit 1
        fi
        
        # Show what we're analyzing
        echo "üìÅ Contents of analysis target:"
        ls -la "${{ inputs.analysis_target }}"
        
        # Find XML files to analyze
        XML_COUNT=$(find "${{ inputs.analysis_target }}" -name "*.xml" -type f | wc -l)
        echo "üìä Found $XML_COUNT XML files to analyze"
        
        if [ $XML_COUNT -eq 0 ]; then
          echo "‚ö†Ô∏è No XML files found in ${{ inputs.analysis_target }}"
          echo "This might not be a MuleSoft project or files are in a different location."
        fi
        
        # Run the analysis
        python mulesoft_ai_code_review_agent.py "${{ inputs.analysis_target }}" comprehensive-mulesoft-ruleset-no-debug.xml -o quality-report.json -v
        
        # Extract results from JSON report
        if [ -f "quality-report.json" ]; then
          echo "‚úÖ Analysis completed successfully"
          
          # Extract compliance score
          COMPLIANCE=$(grep -o '"compliance_percentage":[0-9.]*' quality-report.json | cut -d':' -f2 | head -1)
          TOTAL_VIOLATIONS=$(grep -o '"total_violations":[0-9]*' quality-report.json | cut -d':' -f2 | head -1)
          
          # Fallback calculation if not found
          if [ -z "$COMPLIANCE" ] || [ "$COMPLIANCE" = "0" ]; then
            HIGH_COUNT=$(grep -o '"HIGH":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            MEDIUM_COUNT=$(grep -o '"MEDIUM":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            LOW_COUNT=$(grep -o '"LOW":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            
            DEDUCTION=$((HIGH_COUNT*3 + MEDIUM_COUNT*2 + LOW_COUNT*1))
            COMPLIANCE=$((100 - DEDUCTION))
            
            # Minimum compliance
            if [ $COMPLIANCE -lt 10 ]; then
              COMPLIANCE=10
            fi
          fi
          
          echo "COMPLIANCE_SCORE=$COMPLIANCE" >> $GITHUB_OUTPUT
          echo "TOTAL_VIOLATIONS=${TOTAL_VIOLATIONS:-0}" >> $GITHUB_OUTPUT
          
          echo "üõ°Ô∏è Analysis Results:"
          echo "   - Compliance Score: $COMPLIANCE%"
          echo "   - Total Violations: ${TOTAL_VIOLATIONS:-0}"
          
        else
          echo "‚ùå Analysis failed - no report generated"
          exit 1
        fi
        
    # Step 9: Quality Gate Check
    - name: Quality Gate Check
      id: quality-gate
      run: |
        SCORE=${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}
        THRESHOLD=${{ inputs.compliance_threshold }}
        SKIP_GATE=${{ inputs.skip_quality_gate }}
        
        echo "üìä Quality Gate Check:"
        echo "   - Compliance Score: $SCORE%"
        echo "   - Required Threshold: $THRESHOLD%"
        echo "   - Skip Quality Gate: $SKIP_GATE"
        
        if [ "$SKIP_GATE" = "true" ]; then
          echo "‚ö†Ô∏è Quality gate check skipped"
          echo "GATE_PASSED=true" >> $GITHUB_OUTPUT
        elif (( $(echo "$SCORE >= $THRESHOLD" | bc -l) )); then
          echo "‚úÖ QUALITY GATE PASSED"
          echo "GATE_PASSED=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå QUALITY GATE FAILED"
          echo "Project compliance ($SCORE%) is below required threshold ($THRESHOLD%)"
          echo "GATE_PASSED=false" >> $GITHUB_OUTPUT
          
          if [ "$SKIP_GATE" != "true" ]; then
            exit 1
          fi
        fi
        
    # Step 10: Generate Reports
    - name: Generate Reports
      if: always()
      run: |
        echo "üìÑ Generating HTML report..."
        
        # Extract values for HTML report
        COMPLIANCE_SCORE="${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}"
        TOTAL_VIOLATIONS="${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}"
        PROJECT_NAME="${{ inputs.project_name }}"
        THRESHOLD="${{ inputs.compliance_threshold }}"
        
        # Generate HTML report using echo statements to avoid YAML conflicts
        echo "<!DOCTYPE html>" > quality-report.html
        echo "<html><head><title>Mule Guardian Quality Report - $PROJECT_NAME</title>" >> quality-report.html
        echo "<style>body{font-family:Arial;margin:40px;background:#f5f7fa}.header{background:#667eea;color:white;padding:20px;border-radius:8px;margin-bottom:20px}.metric{display:inline-block;background:white;margin:10px;padding:20px;border-radius:8px;min-width:120px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.metric h2{margin:0;font-size:2em}.metric p{margin:10px 0 0 0;color:#666}.passed{border-left:4px solid #28a745}.failed{border-left:4px solid #dc3545}.summary{background:white;padding:20px;border-radius:8px;margin:20px 0}</style>" >> quality-report.html
        echo "</head><body>" >> quality-report.html
        echo "<div class='header'><h1>üõ°Ô∏è Mule Guardian Quality Report</h1><p>$PROJECT_NAME - Code Quality Analysis Results</p></div>" >> quality-report.html
        
        # Determine status class
        if [ $COMPLIANCE_SCORE -ge $THRESHOLD ]; then
          STATUS_CLASS="passed"
          STATUS_TEXT="‚úÖ PASSED"
        else
          STATUS_CLASS="failed" 
          STATUS_TEXT="‚ùå FAILED"
        fi
        
        echo "<div class='metric $STATUS_CLASS'><h2>${COMPLIANCE_SCORE}%</h2><p>Compliance Score</p><small>Threshold: ${THRESHOLD}%</small></div>" >> quality-report.html
        echo "<div class='metric'><h2>$TOTAL_VIOLATIONS</h2><p>Total Violations</p></div>" >> quality-report.html
        echo "<div class='summary'>" >> quality-report.html
        echo "<h3>Analysis Summary</h3>" >> quality-report.html
        echo "<p><strong>Project:</strong> $PROJECT_NAME</p>" >> quality-report.html
        echo "<p><strong>Analysis Target:</strong> ${{ inputs.analysis_target }}</p>" >> quality-report.html
        echo "<p><strong>Quality Gate:</strong> $STATUS_TEXT</p>" >> quality-report.html
        echo "<p><strong>Timestamp:</strong> $(date)</p>" >> quality-report.html
        echo "</div>" >> quality-report.html
        echo "<p><em>Download the JSON report for detailed violation information.</em></p>" >> quality-report.html
        echo "</body></html>" >> quality-report.html
        
        echo "‚úÖ HTML report generated successfully"
        
    # Step 11: Upload Reports as Artifacts
    - name: Upload Quality Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mule-guardian-quality-report-${{ inputs.project_name }}
        path: |
          quality-report.json
          quality-report.html
        retention-days: 30
        
    # Step 12: Summary
    - name: Analysis Summary
      if: always()
      run: |
        echo "üéâ MULE GUARDIAN ANALYSIS COMPLETED!"
        echo ""
        echo "üìä Results for ${{ inputs.project_name }}:"
        echo "   - Compliance Score: ${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}%"
        echo "   - Total Violations: ${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}"
        echo "   - Quality Gate: $([ "${{ steps.quality-gate.outputs.GATE_PASSED }}" = "true" ] && echo "PASSED" || echo "FAILED")"
        echo ""
        echo "üìÅ Reports uploaded as artifact: mule-guardian-quality-report-${{ inputs.project_name }}"
        echo "üîç Download from Actions tab for detailed analysis"
