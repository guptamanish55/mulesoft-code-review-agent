name: Mule Guardian Code Quality Check (Reusable)

# THIS IS A REUSABLE WORKFLOW - Called from other repositories
on:
  workflow_call:
    inputs:
      # Input parameters that calling repositories can customize
      compliance_threshold:
        description: 'Minimum compliance percentage required'
        required: false
        type: number
        default: 75
      pmd_version:
        description: 'PMD version to use'
        required: false
        type: string
        default: '7.0.0'
      analysis_target:
        description: 'Directory to analyze (relative to repo root)'
        required: false
        type: string
        default: '.'
      project_name:
        description: 'Name of the project being analyzed (defaults to repository name)'
        required: false
        type: string
        default: ''  # Will be dynamically set to repository name if empty
      skip_quality_gate:
        description: 'Skip quality gate check (for debugging)'
        required: false
        type: boolean
        default: false
    outputs:
      # Outputs that calling workflows can use
      compliance_score:
        description: 'Calculated compliance percentage'
        value: ${{ jobs.code-quality-check.outputs.compliance_score }}
      total_violations:
        description: 'Total number of violations found'
        value: ${{ jobs.code-quality-check.outputs.total_violations }}
      quality_gate_passed:
        description: 'Whether quality gate passed'
        value: ${{ jobs.code-quality-check.outputs.quality_gate_passed }}

jobs:
  code-quality-check:
    runs-on: ubuntu-latest
    
    # Set outputs for the job
    outputs:
      compliance_score: ${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}
      total_violations: ${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}
      quality_gate_passed: ${{ steps.quality-gate.outputs.GATE_PASSED }}
    
    steps:
    # Step 1: Get the calling repository's code
    - name: Checkout Application Code
      uses: actions/checkout@v4
      
    # Step 2: Get Mule Guardian files from this common repository
    - name: Get Mule Guardian Core Files
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/mulesoft-code-review-agent  # ‚Üê Change this to your common repo name
        path: mule-guardian
        ref: main
        
    # Step 3: Copy core files to working directory
    - name: Setup Mule Guardian Files
      run: |
        echo "üìã Setting up Mule Guardian files..."
        
        # Copy core files from the common repo checkout
        cp mule-guardian/mulesoft_ai_code_review_agent.py .
        cp mule-guardian/comprehensive-mulesoft-ruleset-no-debug.xml .
        cp mule-guardian/requirements.txt .
        
        echo "‚úÖ Core files copied from common repository"
        
        # Verify files exist
        for file in mulesoft_ai_code_review_agent.py comprehensive-mulesoft-ruleset-no-debug.xml requirements.txt; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Error: $file not found"
            exit 1
          fi
          echo "‚úÖ Found: $file"
        done
      
    # Step 4: Setup Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    # Step 5: Setup Java (required for PMD)
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    # Step 6: Install PMD
    - name: Install PMD
      run: |
        echo "üì¶ Installing PMD version ${{ inputs.pmd_version }}..."
        
        # Set PMD version with fallback to stable version
        PMD_VERSION="${{ inputs.pmd_version }}"
        FALLBACK_VERSION="6.55.0"
        
        # Try downloading PMD with multiple methods
        SUCCESS=false
        
        # Method 1: Try requested version
        echo "üîÑ Trying PMD $PMD_VERSION..."
        if wget --timeout=30 --tries=2 "https://github.com/pmd/pmd/releases/download/pmd_releases%2F${PMD_VERSION}/pmd-bin-${PMD_VERSION}.zip" 2>/dev/null; then
          echo "‚úÖ Downloaded PMD $PMD_VERSION successfully"
          unzip "pmd-bin-${PMD_VERSION}.zip"
          sudo mv "pmd-bin-${PMD_VERSION}" /opt/pmd
          SUCCESS=true
        fi
        
        # Method 2: Try fallback stable version if requested version failed
        if [ "$SUCCESS" = "false" ] && [ "$PMD_VERSION" != "$FALLBACK_VERSION" ]; then
          echo "üîÑ Trying fallback PMD $FALLBACK_VERSION..."
          if wget --timeout=30 --tries=2 "https://github.com/pmd/pmd/releases/download/pmd_releases%2F${FALLBACK_VERSION}/pmd-bin-${FALLBACK_VERSION}.zip" 2>/dev/null; then
            echo "‚úÖ Downloaded PMD $FALLBACK_VERSION as fallback"
            unzip "pmd-bin-${FALLBACK_VERSION}.zip"
            sudo mv "pmd-bin-${FALLBACK_VERSION}" /opt/pmd
            SUCCESS=true
          fi
        fi
        
        # Method 3: Try alternative URL pattern (for older versions)
        if [ "$SUCCESS" = "false" ]; then
          echo "üîÑ Trying alternative URL format..."
          if wget --timeout=30 --tries=2 "https://github.com/pmd/pmd/releases/download/pmd_releases/${PMD_VERSION}/pmd-dist-${PMD_VERSION}-bin.zip" 2>/dev/null; then
            echo "‚úÖ Downloaded PMD $PMD_VERSION with alternative URL"
            unzip "pmd-dist-${PMD_VERSION}-bin.zip"
            sudo mv "pmd-bin-${PMD_VERSION}" /opt/pmd 2>/dev/null || sudo mv "pmd-dist-${PMD_VERSION}" /opt/pmd
            SUCCESS=true
          fi
        fi
        
        # Method 4: Use package manager as last resort
        if [ "$SUCCESS" = "false" ]; then
          echo "‚ö†Ô∏è Direct downloads failed, using Ubuntu package manager..."
          sudo apt-get update -qq
          sudo apt-get install -y pmd 2>/dev/null || true
          
          # Check if pmd command is available
          if command -v pmd >/dev/null 2>&1; then
            echo "‚úÖ PMD installed via package manager"
            # Create directory structure expected by Mule Guardian
            sudo mkdir -p /opt/pmd/bin
            sudo ln -sf $(which pmd) /opt/pmd/bin/pmd
            SUCCESS=true
          else
            echo "‚ùå Package manager installation also failed"
            echo "üîÑ Installing PMD manually using Java..."
            
            # Manual installation - create a simple PMD wrapper
            sudo mkdir -p /opt/pmd/bin
            
            # Try to download a working JAR version
            if wget --timeout=30 "https://repo1.maven.org/maven2/net/sourceforge/pmd/pmd-dist/6.55.0/pmd-dist-6.55.0-bin.zip" 2>/dev/null; then
              unzip pmd-dist-6.55.0-bin.zip
              sudo mv pmd-bin-6.55.0 /opt/pmd
              SUCCESS=true
            else
              echo "‚ùå All PMD installation methods failed"
              exit 1
            fi
          fi
        fi
        
        # Create expected paths for Mule Guardian compatibility
        echo "üîó Setting up PMD paths for Mule Guardian..."
        sudo mkdir -p /opt/homebrew/bin
        
        # Ensure PMD binary exists and is executable
        if [ -f "/opt/pmd/bin/pmd" ]; then
          sudo chmod +x /opt/pmd/bin/pmd
          sudo ln -sf /opt/pmd/bin/pmd /opt/homebrew/bin/pmd
        elif [ -f "/opt/pmd/bin/run.sh" ]; then
          # Some PMD versions use run.sh
          sudo ln -sf /opt/pmd/bin/run.sh /opt/pmd/bin/pmd
          sudo ln -sf /opt/pmd/bin/pmd /opt/homebrew/bin/pmd
        fi
        
        # Add to PATH
        echo "/opt/pmd/bin" >> $GITHUB_PATH
        echo "/opt/homebrew/bin" >> $GITHUB_PATH
        export PATH="/opt/pmd/bin:/opt/homebrew/bin:$PATH"
        
        # Verify PMD installation with correct command structure
        echo "üß™ Verifying PMD installation..."
        
        # PMD 7.x uses: pmd check --version
        # PMD 6.x uses: pmd --version or pmd -v
        # Try multiple command formats for compatibility
        PMD_VERIFIED=false
        
        for pmd_path in "/opt/pmd/bin/pmd" "/opt/homebrew/bin/pmd"; do
          if [ -f "$pmd_path" ]; then
            echo "Testing PMD at: $pmd_path"
            
            # Try different version check methods
            if $pmd_path --version 2>/dev/null | grep -i "pmd" >/dev/null; then
              echo "‚úÖ PMD verified at $pmd_path (using --version)"
              PMD_VERIFIED=true
              break
            elif $pmd_path -v 2>/dev/null | grep -i "pmd" >/dev/null; then
              echo "‚úÖ PMD verified at $pmd_path (using -v)"
              PMD_VERIFIED=true
              break
            elif $pmd_path check --version 2>/dev/null | grep -i "pmd" >/dev/null; then
              echo "‚úÖ PMD verified at $pmd_path (using check --version)"
              PMD_VERIFIED=true
              break
            else
              echo "‚ö†Ô∏è Version check failed for $pmd_path, but file exists"
            fi
          fi
        done
        
        if [ "$PMD_VERIFIED" = "false" ]; then
          echo "‚ö†Ô∏è PMD version verification failed, but installation appears successful"
          echo "üîç Available PMD sub-commands:"
          /opt/pmd/bin/pmd 2>&1 | head -10 || true
        fi
        
        echo "‚úÖ PMD installation completed successfully"
        
    # Step 7: Install Python Dependencies
    - name: Install Python Dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        
        # Upgrade pip to latest version to better handle dependency resolution
        python -m pip install --upgrade pip
        
        # Install dependencies with better error handling
        echo "üîÑ Installing from requirements.txt..."
        if pip install -r requirements.txt; then
          echo "‚úÖ Python dependencies installed successfully"
        else
          echo "‚ö†Ô∏è Initial installation failed, trying with dependency resolver..."
          # Try with backtracking resolver for better conflict resolution
          pip install -r requirements.txt --use-deprecated=backtrack-on-build-failures || {
            echo "‚ùå Dependency installation failed"
            echo "üìã Installed packages before failure:"
            pip list
            echo "üîç Checking for specific conflicts..."
            pip check || true
            exit 1
          }
          echo "‚úÖ Python dependencies installed with conflict resolution"
        fi
        
        echo "üìã Final installed packages:"
        pip list
        
    # Step 8: Run Mule Guardian Analysis
    - name: Run Mule Guardian Analysis
      id: mule-analysis
      run: |
        echo "üîç Starting Mule Guardian analysis..."
        
        # Set dynamic project name if not provided
        if [ -z "${{ inputs.project_name }}" ] || [ "${{ inputs.project_name }}" = "" ]; then
          PROJECT_NAME="${{ github.event.repository.name }}"
          echo "üìç Project: $PROJECT_NAME (auto-detected from repository)"
        else
          PROJECT_NAME="${{ inputs.project_name }}"
          echo "üìç Project: $PROJECT_NAME (user-provided)"
        fi
        
        echo "üìÇ Analyzing: ${{ inputs.analysis_target }}"
        echo "üè¢ Repository: ${{ github.repository }}"
        echo "üåø Branch: ${{ github.ref_name }}"
        
        # Validate analysis target
        if [ ! -d "${{ inputs.analysis_target }}" ]; then
          echo "‚ùå Analysis target directory not found: ${{ inputs.analysis_target }}"
          exit 1
        fi
        
        # Show what we're analyzing
        echo "üìÅ Contents of analysis target:"
        ls -la "${{ inputs.analysis_target }}"
        
        # Find XML files to analyze
        XML_COUNT=$(find "${{ inputs.analysis_target }}" -name "*.xml" -type f | wc -l)
        echo "üìä Found $XML_COUNT XML files to analyze"
        
        if [ $XML_COUNT -eq 0 ]; then
          echo "‚ö†Ô∏è No XML files found in ${{ inputs.analysis_target }}"
          echo "This might not be a MuleSoft project or files are in a different location."
        fi
        
        # Run the analysis
        python mulesoft_ai_code_review_agent.py "${{ inputs.analysis_target }}" comprehensive-mulesoft-ruleset-no-debug.xml -o quality-report.json -v
        
        # Extract results from JSON report
        if [ -f "quality-report.json" ]; then
          echo "‚úÖ Analysis completed successfully"
          
          # Extract compliance score
          COMPLIANCE=$(grep -o '"compliance_percentage":[0-9.]*' quality-report.json | cut -d':' -f2 | head -1)
          TOTAL_VIOLATIONS=$(grep -o '"total_violations":[0-9]*' quality-report.json | cut -d':' -f2 | head -1)
          
          # Fallback calculation if not found
          if [ -z "$COMPLIANCE" ] || [ "$COMPLIANCE" = "0" ]; then
            HIGH_COUNT=$(grep -o '"HIGH":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            MEDIUM_COUNT=$(grep -o '"MEDIUM":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            LOW_COUNT=$(grep -o '"LOW":[0-9]*' quality-report.json | cut -d':' -f2 | head -1 || echo "0")
            
            DEDUCTION=$((HIGH_COUNT*3 + MEDIUM_COUNT*2 + LOW_COUNT*1))
            COMPLIANCE=$((100 - DEDUCTION))
            
            # Minimum compliance
            if [ $COMPLIANCE -lt 10 ]; then
              COMPLIANCE=10
            fi
          fi
          
          echo "COMPLIANCE_SCORE=$COMPLIANCE" >> $GITHUB_OUTPUT
          echo "TOTAL_VIOLATIONS=${TOTAL_VIOLATIONS:-0}" >> $GITHUB_OUTPUT
          
          echo "üõ°Ô∏è Analysis Results:"
          echo "   - Compliance Score: $COMPLIANCE%"
          echo "   - Total Violations: ${TOTAL_VIOLATIONS:-0}"
          
        else
          echo "‚ùå Analysis failed - no report generated"
          exit 1
        fi
        
    # Step 9: Quality Gate Check
    - name: Quality Gate Check
      id: quality-gate
      run: |
        SCORE=${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}
        THRESHOLD=${{ inputs.compliance_threshold }}
        SKIP_GATE=${{ inputs.skip_quality_gate }}
        
        echo "üìä Quality Gate Check:"
        echo "   - Compliance Score: $SCORE%"
        echo "   - Required Threshold: $THRESHOLD%"
        echo "   - Skip Quality Gate: $SKIP_GATE"
        
        if [ "$SKIP_GATE" = "true" ]; then
          echo "‚ö†Ô∏è Quality gate check skipped"
          echo "GATE_PASSED=true" >> $GITHUB_OUTPUT
        elif (( $(echo "$SCORE >= $THRESHOLD" | bc -l) )); then
          echo "‚úÖ QUALITY GATE PASSED"
          echo "GATE_PASSED=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå QUALITY GATE FAILED"
          echo "Project compliance ($SCORE%) is below required threshold ($THRESHOLD%)"
          echo "GATE_PASSED=false" >> $GITHUB_OUTPUT
          
          if [ "$SKIP_GATE" != "true" ]; then
            exit 1
          fi
        fi
        
    # Step 10: Generate Reports
    - name: Generate Reports
      if: always()
      run: |
        echo "üìÑ Generating HTML report..."
        
        # Extract values for HTML report
        COMPLIANCE_SCORE="${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}"
        TOTAL_VIOLATIONS="${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}"
        PROJECT_NAME="${{ inputs.project_name }}"
        THRESHOLD="${{ inputs.compliance_threshold }}"
        
        # Generate HTML report using echo statements to avoid YAML conflicts
        echo "<!DOCTYPE html>" > quality-report.html
        echo "<html><head><title>Mule Guardian Quality Report - $PROJECT_NAME</title>" >> quality-report.html
        echo "<style>body{font-family:Arial;margin:40px;background:#f5f7fa}.header{background:#667eea;color:white;padding:20px;border-radius:8px;margin-bottom:20px}.metric{display:inline-block;background:white;margin:10px;padding:20px;border-radius:8px;min-width:120px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.metric h2{margin:0;font-size:2em}.metric p{margin:10px 0 0 0;color:#666}.passed{border-left:4px solid #28a745}.failed{border-left:4px solid #dc3545}.summary{background:white;padding:20px;border-radius:8px;margin:20px 0}</style>" >> quality-report.html
        echo "</head><body>" >> quality-report.html
        echo "<div class='header'><h1>üõ°Ô∏è Mule Guardian Quality Report</h1><p>$PROJECT_NAME - Code Quality Analysis Results</p></div>" >> quality-report.html
        
        # Determine status class
        if [ $COMPLIANCE_SCORE -ge $THRESHOLD ]; then
          STATUS_CLASS="passed"
          STATUS_TEXT="‚úÖ PASSED"
        else
          STATUS_CLASS="failed" 
          STATUS_TEXT="‚ùå FAILED"
        fi
        
        echo "<div class='metric $STATUS_CLASS'><h2>${COMPLIANCE_SCORE}%</h2><p>Compliance Score</p><small>Threshold: ${THRESHOLD}%</small></div>" >> quality-report.html
        echo "<div class='metric'><h2>$TOTAL_VIOLATIONS</h2><p>Total Violations</p></div>" >> quality-report.html
        echo "<div class='summary'>" >> quality-report.html
        echo "<h3>Analysis Summary</h3>" >> quality-report.html
        echo "<p><strong>Project:</strong> $PROJECT_NAME</p>" >> quality-report.html
        echo "<p><strong>Analysis Target:</strong> ${{ inputs.analysis_target }}</p>" >> quality-report.html
        echo "<p><strong>Quality Gate:</strong> $STATUS_TEXT</p>" >> quality-report.html
        echo "<p><strong>Timestamp:</strong> $(date)</p>" >> quality-report.html
        echo "</div>" >> quality-report.html
        echo "<p><em>Download the JSON report for detailed violation information.</em></p>" >> quality-report.html
        echo "</body></html>" >> quality-report.html
        
        echo "‚úÖ HTML report generated successfully"
        
    # Step 11: Upload Reports as Artifacts
    - name: Upload Quality Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mule-guardian-quality-report-${{ inputs.project_name }}
        path: |
          quality-report.json
          quality-report.html
        retention-days: 30
        
    # Step 12: Summary
    - name: Analysis Summary
      if: always()
      run: |
        echo "üéâ MULE GUARDIAN ANALYSIS COMPLETED!"
        echo ""
        echo "üìä Results for ${{ inputs.project_name }}:"
        echo "   - Compliance Score: ${{ steps.mule-analysis.outputs.COMPLIANCE_SCORE }}%"
        echo "   - Total Violations: ${{ steps.mule-analysis.outputs.TOTAL_VIOLATIONS }}"
        echo "   - Quality Gate: $([ "${{ steps.quality-gate.outputs.GATE_PASSED }}" = "true" ] && echo "PASSED" || echo "FAILED")"
        echo ""
        echo "üìÅ Reports uploaded as artifact: mule-guardian-quality-report-${{ inputs.project_name }}"
        echo "üîç Download from Actions tab for detailed analysis"
